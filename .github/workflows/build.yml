name: Build & Upload Artifact

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Build Unsigned IPA
    runs-on: macOS-15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true # 必须开启，解决 XCFramework 缺失问题

      - name: Force LFS Pull
        run: git lfs pull

      - name: Build via Fastlane (No Signing)
        # 这里直接调用 gym (build_app) 而不走 beta lane，避免触发上传
        run: |
          bundle exec fastlane gym \
            --scheme "Code App" \
            --clean true \
            --output_directory "./" \
            --output_name "Code.ipa" \
            --skip_profile_detection true \
            --export_method "ad-hoc" \
            --xcargs "CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO CODE_SIGN_IDENTITY='' CODE_SIGN_ENTITLEMENTS='' GCC_GENERATE_DEBUGGING_SYMBOLS=NO"
        env:
          # 哪怕不签名，也保留这些变量，因为你的项目脚本或 Fastlane 插件可能在读取它们
          APP_STORE_CONNECT_TEAM_ID: "${{ secrets.APP_STORE_CONNECT_TEAM_ID }}"
          DEVELOPER_APP_ID: "${{ secrets.DEVELOPER_APP_ID }}"
          DEVELOPER_APP_IDENTIFIER: "${{ secrets.DEVELOPER_APP_IDENTIFIER }}"
          DEVELOPER_PORTAL_TEAM_ID: "${{ secrets.DEVELOPER_PORTAL_TEAM_ID }}"
          MATCH_PASSWORD: "${{ secrets.MATCH_PASSWORD }}"
          GIT_AUTHORIZATION: "${{ secrets.GIT_AUTHORIZATION }}"
          TEMP_KEYCHAIN_PASSWORD: "${{ secrets.TEMP_KEYCHAIN_PASSWORD }}"
          TEMP_KEYCHAIN_USER: "${{ secrets.TEMP_KEYCHAIN_USER }}"
          APPLE_KEY_ID: "${{ secrets.APPLE_KEY_ID }}"
          APPLE_ISSUER_ID: "${{ secrets.APPLE_ISSUER_ID }}"
          APPLE_KEY_CONTENT: "${{ secrets.APPLE_KEY_CONTENT }}"
          XCODE_PATH: "/Applications/Xcode_16.0.app"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: CodeApp-Unsigned
          path: Code.ipa
          retention-days: 5
