name: Build & Upload Artifact

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Build Unsigned IPA
    runs-on: macOS-15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true # 解决 XCFramework 缺失的关键

      - name: Force LFS Pull
        run: git lfs pull

      - name: Fix Bundler Version & Build
        # 1. 安装兼容 Fastlane 的 Bundler 版本
        # 2. 直接运行 fastlane gym (不使用 bundle exec 避免版本冲突)
        run: |
          gem install bundler:2.5.23 
          fastlane gym \
            --scheme "Code App" \
            --clean true \
            --output_directory "./" \
            --output_name "Code.ipa" \
            --skip_profile_detection true \
            --export_method "ad-hoc" \
            --xcargs "CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO CODE_SIGN_IDENTITY='' CODE_SIGN_ENTITLEMENTS='' GCC_GENERATE_DEBUGGING_SYMBOLS=NO"
        env:
          # 保留原始环境变量以确保插件或脚本能获取项目上下文
          APP_STORE_CONNECT_TEAM_ID: "${{ secrets.APP_STORE_CONNECT_TEAM_ID }}"
          DEVELOPER_APP_ID: "${{ secrets.DEVELOPER_APP_ID }}"
          DEVELOPER_APP_IDENTIFIER: "${{ secrets.DEVELOPER_APP_IDENTIFIER }}"
          DEVELOPER_PORTAL_TEAM_ID: "${{ secrets.DEVELOPER_PORTAL_TEAM_ID }}"
          MATCH_PASSWORD: "${{ secrets.MATCH_PASSWORD }}"
          GIT_AUTHORIZATION: "${{ secrets.GIT_AUTHORIZATION }}"
          TEMP_KEYCHAIN_PASSWORD: "${{ secrets.TEMP_KEYCHAIN_PASSWORD }}"
          TEMP_KEYCHAIN_USER: "${{ secrets.TEMP_KEYCHAIN_USER }}"
          APPLE_KEY_ID: "${{ secrets.APPLE_KEY_ID }}"
          APPLE_ISSUER_ID: "${{ secrets.APPLE_ISSUER_ID }}"
          APPLE_KEY_CONTENT: "${{ secrets.APPLE_KEY_CONTENT }}"
          XCODE_PATH: "/Applications/Xcode_16.0.app"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: CodeApp-Unsigned-IPA
          path: Code.ipa
          retention-days: 5
